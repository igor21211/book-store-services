# book-store-services
This my first microservice App
![Screenshot from 2023-05-24 21-07-56](https://github.com/igor21211/book-store-services/assets/86198126/740d1465-6072-4abd-a2c8-d142ef2b775d)

## Catalog-service 
главная задача данного сервиса это хранение продукта(книги) и характеристик их
В нем реализован Добавление ,изменение,удаление  и выборка с     сортировками  и фильтрациями
Каталог сервес имеет одну очередь "new_book" в которую кидает информацию о добавленом продукте(книге) в сервис mail-notification-service где в свою очередь происходит расзылка писем по почтам юзерам у которые отвечают критериям
Юзерам на почту приходит письмо с информацией о новом продукте
Название
Автор
Картинка
Цена

## Curt-service  
главная задача сервиса хранение сущностей которые добавил юзер в корзину
Перед добавлением делаем запросы через лоадбалансер на сервис profile-service и catalog-service для информации существует ли такой товар а так же существует ли такой юзер и активный ли он(про активность в сервисе профиля) если товар 
присутствует и юзер отвечает всем требованиям происходит добавление в корзину
А так же он проверяет поле Quantity если значение у этого поля = 0 то он отдаст ошибку с сообщением что кол = 0 если юзер добавить в корзину товар quantity которое больше чем есть в наличии он тоже получит ошибку с сообщением
При этом кидается в очередь сообщение addOrder для создании сделки в сервисе order-service
Сервис так же имеет запросы на редактирование, удаление и запрос с сортировкой и фильтрацей для выдачи

## Profile-service 
главная задача сервиса хранение и обработка других запросов связаных с пользователями
При добавлении пользователя в очередь mail_sender_user падает сообщение с данными пользователя в сервис mail-notification-service в котором отправляется письмо на почту которую указал юзер при регистрации с ссылкой 
активации при переходе по ссылке в колонке active проставляется значение true=активный false=не активный(не подтвержденый)
Так же при создании юзера можно указать значение полю email_request по дефолту true это поле отвечает за разрешение юзера о разсылки писем юзеру на почту, если юзер захочет отказатся от расзылки есть на это апи метод который изменит значение 
email_request на  false в бд users а так же кингет сообщение в очередь deactivate_mail где на выходе примет его сервис mail-notification-service и изменит это поле на значение false у себя в бд

## Mail-notification-service 
главная задача сервиса это отправка писем пользователям как ответ на их дейтвия включает в себя поведение такие как:
Регистрация пользователя  - идет разсылка для активации аккаунта
Добавление новой книги  - идет разсылка всем пользователям у кого поле email_request=true
Успешная оплата - после успешной оплаты идет разсылка юзеру о предметах  которые он купил и общей ценой

## Order-service 
главная задача сервиса хранение заказов которые прилетают из корзины а так же сбор всех заказов по айди юзеру и отправка в payment-service в очередь payments где хрантся вся информация о покупке общая цена, 
количество покупаемых товаров , айди юзера который покупает а так же статус заявки на покупку
status_id:1  (есть все-го 3 статуса 1(created) 2(in_progress) 3(payment_done))
Есть еще одна очередь info_payments сделал ее исключительно для отрисовки корзины тоисть информации о покупаемом товаре
Сервис так же как все имеет добавление которое происходит сообщением из очереди изменением а так же удалением сущностей
Получение данных по заказах с сортировкой и фильтрацией
У каждого заказа есть поле status - по дефолту оно true после успешной оплаты приходит сообщение из очереди payment_result в котором мы меняем status на true по id юзера

##  payment-service 
главная задача сервиса обрабатывать платежи и отдавать ответ по очередям по платежу
Платеж интегрирован с помощью платформы PayPal в тестовом режиме PayPalSandbox который реализован пост запрос с общей суммой и другми характеристиками
Сервис имеет страницу котороя сделана на шаблонизаторе где генерируется установка счета и отрисовка покупаемых товаров
Создание счета происходит когда приходит сообщение в очередь payments создается счет для юзера где в урле счета указывается айди юзера
Допольнительные данные по листу покупаемых продуктов приходит из очереди info_payments
После успешной покупки юзера редиректит на страницу с благодарностью покупкой в нашем магазине
В то же время идет разсылка по очередям в succesful_result_to_mail pay_result_to_basket payments_result minus_quantity
Curt-service идет сообщение для проставлении статуса по данным покупкам юзера true(данные записи больше вытягиватся не будут с таким статусом и считаются оплачеными храним для истории)
Order-service идет сообщение для изменение статуса заявки на true (оплачена) так же больше тянутся и добавлятся в очередь такие заявки не будут тоже считаем их оплачеными
mail-notification-service - вытягивает почту юзера и отправляет письмо о успешной покупке демонстрируя товары и сумму покупки
Вконце из сообщения которое идет из очереди minus_quantity сервис каталог отнимает то количество из тех товаров которые купил юзер в последствии новый юзер не сможет добавить товар если у него quantity = 0 либо если кол товара меньше за то что юзер добавляет в корзину
Сам же сервис удаляет все данные в таблице product и ставит статус 3(payment_done) о успешной оплате
